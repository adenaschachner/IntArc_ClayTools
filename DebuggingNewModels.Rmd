---
title: "IntArch_ClayTools_Adult_Model"
author: "Ethan Hurwitz"
date: "9/26/2018"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
library(tidyverse)
library(stats4)
library(papaja)
library(ggpmisc)
library(ggpubr)
library(pbapply)
```

#Data cleaning

```{r data cleaning}

dat <- read.csv("IntArch_TestData.csv", stringsAsFactors = F)

#Filter out data to be excluded:

# #Memory check questions:
# ##Star box
# 
# dat %>%
#   filter(MemCheck_RodStar == "Star rod") %>% 
#   filter(MemCheck_RodCir == "All of the rod pieces") %>%
#   filter(MemCheck_HanCir == "All of the handle pieces") %>%
#   filter(MemCheck_HanStar == "All of the handle pieces")
# 
# #Score the lextale
# dat %>% 
#   mutate(score = (((apply(dat %>%
#   select(ends_with(match = "_Y")), 1, function(x) sum(x=="Yes, this is English")))/20*100) + ((apply(dat %>%
#   select(ends_with(match = "_N")), 1, function(x) sum(x=="No, this is not English")))/10*100))/2) 
# 
# ##Completion time
# dat$`timing_Page,Submit` <- as.numeric(as.character(dat$`timing_Page,Submit`))
# 
# mean(as.numeric(as.character(dat$`timing_Page,Submit`)))
# sd(as.numeric(as.character(dat$`timing_Page,Submit`)))*2
# 
# dat %>%
#   filter(`timing_Page,Submit` <= (mean(dat$`timing_Page,Submit`) + sd(dat$`timing_Page,Submit`)))

# remove extra qualtrics headers, and columns that are non-data (dates, times, etc)
dat <- dat[-(1:2),-(1:18)]

# make the column names more meaningful
names(dat) <- gsub("HId", "Iden", names(dat))
names(dat) <- gsub("RId", "Iden", names(dat))
names(dat) <- gsub("HDi", "Dif", names(dat))
names(dat) <- gsub("RDi", "Dif", names(dat))
names(dat) <- gsub("[.]", ",", names(dat))


# removes the memory check questions from the dataset
DatCopy <- dat %>%
  select(-c(grep("Ha", names(dat)), grep("Ro", names(dat)), grep("Bo", names(dat)), ends_with(match = "H", vars = names(dat)), ends_with(match = "R", vars = names(dat)), ends_with(match = "B", vars = names(dat)))) %>%
  select(1:24)

DatCopy <- cbind(PID = 1:nrow(DatCopy), DatCopy)
```

##Tidy data

```{r tidy the data}
DatCopy2 <- DatCopy %>%
  gather(condition, Response,-PID) %>%
  separate(condition, c('Box', 'HandleSimilarity', 'RodSimilarity', 'NumHandleChoices', 'NumRodChoices'),',') %>%
  mutate(NumHandleChoices = as.numeric(NumHandleChoices),
         NumRodChoices = as.numeric(NumRodChoices),
         Box = as.factor(Box),
         HandleIsDiff = HandleSimilarity == 'Dif', # check that this actually is the right string
         RodIsDiff = RodSimilarity == 'Dif',
         JudgedCopied = Response == 'Someone copied.') %>%
  filter(Response != "")

```

#Model creation

##model base

```{r model base}
ModelBase = function(Box, HandleIsDiff, RodIsDiff, NumHandleChoices, NumRodChoices, priorCopy, Response, errorRate){
  
  # RodIsDiff and HandleIsDiff are logicals (0/1, or T/F)
  likelihoodIfCopyingHandleOnly <- ((RodIsDiff) * ((NumRodChoices-1)/NumRodChoices) + # if rod is different 
                                    (1-RodIsDiff) * (1/NumRodChoices)) * # if rod is the same
                                    ((HandleIsDiff) * errorRate +         # if handle is different
                                    (1-HandleIsDiff) * (1-errorRate))    # if handle is the same
  
  likelihoodIfCopyingRodOnly <-   ((RodIsDiff)      * errorRate +
                                   (1-RodIsDiff)    * (1-errorRate)) *
                                  ((HandleIsDiff)   * ((NumHandleChoices-1)/NumHandleChoices) + 
                                   (1-HandleIsDiff) * (1/NumHandleChoices))
  
  likelihoodIfCopyingAll <-       ((RodIsDiff)      * errorRate +
                                   (1-RodIsDiff)    * (1-errorRate)) *
                                  ((HandleIsDiff)   * errorRate +
                                   (1-HandleIsDiff) * (1-errorRate))
  
  likelihoodIfNoCopying <-        ((RodIsDiff)      * ((NumRodChoices-1)/NumRodChoices) +
                                   (1-RodIsDiff)    * (1/NumRodChoices)) *
                                  ((HandleIsDiff)   * ((NumHandleChoices-1)/NumHandleChoices) +
                                   (1-HandleIsDiff) * (1/NumHandleChoices))

  # priors here are specified as rod, then handle
  AdjustedLikelihoodIfCopyingAll        <- priorCopy     * priorCopy     * likelihoodIfCopyingAll
  AdjustedLikelihoodIfCopyingHandleOnly <- (1-priorCopy) * priorCopy     * likelihoodIfCopyingHandleOnly
  AdjustedLikelihoodIfCopyingRodOnly    <- priorCopy     * (1-priorCopy) * likelihoodIfCopyingRodOnly
  AdjustedLikelihoodIfNoCopying         <- (1-priorCopy) * (1-priorCopy) * likelihoodIfNoCopying
  
  SumAdjustedLikeCopy <- AdjustedLikelihoodIfCopyingAll + 
    AdjustedLikelihoodIfCopyingHandleOnly + 
    AdjustedLikelihoodIfCopyingRodOnly
  
  PosteriorCopying <- SumAdjustedLikeCopy / (AdjustedLikelihoodIfNoCopying + SumAdjustedLikeCopy)
  PosteriorNoCopying <- AdjustedLikelihoodIfNoCopying / (AdjustedLikelihoodIfNoCopying + SumAdjustedLikeCopy)
  
  if(Response == "Someone copied."){
    return(PosteriorCopying)
  } else {
    return(PosteriorNoCopying)
  }
}

```

## Full model- takes into account constraints of the puzzle box, as well as number of available choices to build with

```{r full model}

ModelFull = function(Box, HandleIsDiff, RodIsDiff, NumHandleChoices, NumRodChoices, priorCopy, Response, errorRate){
 
  # Take into account the physical constraints of the box: For StarBox, there's only 1 rod option that works. (All handle options always work, on both boxes. For circle box, all rod options work.)
  if(Box == 'Star'){
    NumRodChoices <- 1
  }
  
  ModelBase(Box, HandleIsDiff, RodIsDiff, NumHandleChoices, NumRodChoices, priorCopy, Response, errorRate)
}
```

##Ignores star constraint (ISC) model- does not take into account constraints of the puzzle box

```{r ignore star constraint model}
ModelISC = function(Box, HandleIsDiff, RodIsDiff, NumHandleChoices, NumRodChoices, priorCopy, Response, errorRate){

    # Note that in contrast to the full model, this model does not adjust the value of NumRodChoices to take into account the StarBox constraint.
  
    ModelBase(Box, HandleIsDiff, RodIsDiff, NumHandleChoices, NumRodChoices, priorCopy, Response, errorRate)

}
```



#Full model

##likelihood function for mle()

```{r Full model likelihood Function Wrapper}
CopyLlhFull = function(priorCopy, errorRate){
  tempData = DatCopy2 %>%
    rowwise() %>%
    mutate(pred = ModelFull(Box, HandleIsDiff, RodIsDiff, NumHandleChoices, NumRodChoices, priorCopy, Response, errorRate))
  -sum(log(tempData$pred))
}
```



##Run mle() to find best prior and the likelihood of that prior

```{r Full model mle}
#cannot use 0 and 1 because it will result in (NaN)
LwrsFull = c(0.000000001, .000001) 
UprsFull = c(0.999999999, .1)
InitsFull = list(priorCopy = mean(DatCopy2$Response == "Someone copied."),
                 errorRate = ((.000001+.1)/2))

FitFull <- mle(CopyLlhFull, start = InitsFull, lower = LwrsFull, upper = UprsFull, method = 'L-BFGS-B')

summary(FitFull) #-2logLik for all data

#coef(FitFull) to pull out the coefficients (prior/parameters)
#logLik(FitFull) to pull out the -loglik
```

##bootstrap subjects to get errorbars on BICs

###Function to create new samples

```{r bootstrap sample function}
xnew = function(){sample_n(DatCopy, nrow(DatCopy), replace=TRUE) %>% 
    gather(condition, Result, -PID) %>%
    separate(condition, c('Box', 'HandleSimilarity', 'RodSimilarity', 'NumHandleChoices', 'NumRodChoices'),',') %>%
    mutate(NumHandleChoices = as.numeric(NumHandleChoices),
           NumRodChoices = as.numeric(NumRodChoices)) %>%
    filter(Result != "")
    } 
```

###function to create new BICs from random sample

```{r new full model BICs from samples}
#Because all of the below are using randomly generated samples, they have to be contained within the same function(/environment) otherwise they will be using different samples.

ResampleBicsFull = function(){temp = xnew()
TestLlhFull = function(priorCopy){
  tempData = temp %>%
    rowwise() %>%
    mutate(pred = ModelFull(Box, HandleSimilarity, RodSimilarity, NumHandleChoices, NumRodChoices, priorCopy, Result))
  -sum(log(tempData$pred))
}
InitsTestFull = list(priorCopy = mean((temp %>% 
                                      select(Result)) == "Someone copied."))
FitTestFull <- mle(TestLlhFull, start = InitsTestFull, lower = LwrsFull, upper = UprsFull, method = 'L-BFGS-B')
return(((-2*logLik(FitTestFull)[1])+(1*nrow(temp))))
}
```

###bootstrap BICs for full model

```{r bootstrap BICs for full model}
SamplesFull <- pbreplicate(10000,ResampleBicsFull())
mean(SamplesFull)
quantile(SamplesFull, c(0.025, 0.975))
FullDf <- data.frame(Model = 'Full.Model',
                      BicMean = mean(SamplesFull),
                      BicUpper = mean(SamplesFull) + sd(SamplesFull),
                      BicLower = mean(SamplesFull) - sd(SamplesFull))
```


#Model that ignores the starbox constraint (ISC)

##ISC model likelihood function for mle()

```{r ISC model likelihood function wrapper}
CopyLlhISC = function(priorCopy){
  tempData = DatCopy2 %>%
    rowwise() %>%
    mutate(pred = ModelISC(Box, HandleSimilarity, RodSimilarity, NumHandleChoices, NumRodChoices, priorCopy, Result))
  -sum(log(tempData$pred))
}
```

##Run mle() to find best prior and the likelihood

```{r ISC model mle}
#since only the model and likelihood function wrapper change here, can use the upper, lower, and starting values above.
FitISC <- mle(CopyLlhISC, start = InitsFull, lower = LwrsFull, upper = UprsFull, method = 'L-BFGS-B')

summary(FitISC)
```

##bootstrap subjects to get errorbars on BICs

###function to create new BICs from random sample

```{r new ISC model BICs from samples}
ResampleBicsISC = function(){temp = xnew()
TestLlhISC = function(priorCopy){
  tempData = temp %>%
    rowwise() %>%
    mutate(pred = ModelISC(Box, HandleSimilarity, RodSimilarity, NumHandleChoices, NumRodChoices, priorCopy, Result))
  -sum(log(tempData$pred))
}
InitsTestISC = list(priorCopy = mean((temp %>% 
                                      select(Result)) == "Someone copied."))
FitTestISC <- mle(TestLlhISC, start = InitsTestISC, lower = LwrsFull, upper = UprsFull, method = 'L-BFGS-B')
return(((-2*logLik(FitTestISC)[1])+(1*nrow(temp))))
}
```

###bootstrap BICs for ISC model

```{r bootstrap BICs for ISC model}
SamplesISC <- pbreplicate(10000,ResampleBicsISC())
mean(SamplesISC)
quantile(SamplesISC, c(0.025, 0.975))

ISCDf <- data.frame(Model = 'ISC.Model',
                      BicMean = mean(SamplesISC),
                      BicUpper = mean(SamplesISC) + sd(SamplesISC),
                      BicLower = mean(SamplesISC) - sd(SamplesISC))
```

#Model that ignores the number of options, e.g., 1/10 becomes 1/N. (nChoice):

##likelihood function for mle()

```{r nChoice likelihood function wrapper}
CopyLlhNChoice = function(priorCopy, nChoices){
  tempData = DatCopy2 %>%
    rowwise() %>%
    mutate(pred = ModelFull(Box, HandleSimilarity, RodSimilarity, nChoices, nChoices, priorCopy, Result))
  -sum(log(tempData$pred))
}
```

##Run mle() to find best prior, best number of options, and the likelihood

```{r nChoice model mle}
LwrsNChoice = c(0.000000001, 1.000000001) #different values for nchoices
UprsNChoice = c(0.999999999, Inf)
InitsNChoice = list(priorCopy = mean(DatCopy2$Result == "Someone copied."),
             nChoices = round(mean(c(DatCopy2$NumHandleChoices, DatCopy2$NumRodChoices))))

FitNChoice = mle(CopyLlhNChoice, start = InitsNChoice, lower = LwrsNChoice, upper = UprsNChoice, method = 'L-BFGS-B')

summary(FitNChoice)
```

##bootstrap subjects to get errorbars on BICs

###function to create new BICs from random sample

```{r new nChoice model BICs from samples}
ResampleBicsNChoice = function(){temp = xnew()
TestLlhNChoice = function(priorCopy, nChoices){
  tempData = temp %>%
    rowwise() %>%
    mutate(pred = ModelFull(Box, HandleSimilarity, RodSimilarity, nChoices, nChoices, priorCopy, Result))
  -sum(log(tempData$pred))
}
InitsTestNChoice = list(priorCopy = mean((temp %>% 
                                              select(Result)) == "Someone copied."),
                          nChoices = round(mean(c(temp$NumHandleChoices, temp$NumRodChoices))))
FitTestNChoice <- mle(TestLlhNChoice, start = InitsTestNChoice, lower = LwrsNChoice, upper = UprsNChoice, method = 'L-BFGS-B')
return(((-2*logLik(FitTestNChoice)[1])+(2*nrow(temp))))
}
```

###bootstrap BICs for nChoice model

```{r bootstrap BICs for nChoice model}
SamplesNChoice <- pbreplicate(10000,ResampleBicsNChoice())
mean(SamplesNChoice)
quantile(SamplesNChoice, c(0.025, 0.975))

NChoiceDf <- data.frame(Model = 'nChoice.Model',
                      BicMean = mean(SamplesNChoice),
                      BicUpper = mean(SamplesNChoice) + sd(SamplesNChoice),
                      BicLower = mean(SamplesNChoice) - sd(SamplesNChoice))
```

#Build model that ignores the star constraint AND the number of options (ISCnChoice):

##likelihood function for mle()

```{r ISCnChoice model likelihood function wrapper}
CopyLlhISCnChoice = function(priorCopy, nChoices){
  tempData = DatCopy2 %>%
    rowwise() %>%
    mutate(pred = ModelISC(Box, HandleSimilarity, RodSimilarity, nChoices, nChoices, priorCopy, Result))
  -sum(log(tempData$pred))
}
```

##Run mle() to find best prior, best number of choices, and the likelihood

```{r ISCnChoice model mle}
#Again, all that's changed is the model, so we can just use the start, lower, and upper, values from above

FitISCnChoice = mle(CopyLlhISCnChoice, start = InitsNChoice, lower = LwrsNChoice, upper = UprsNChoice,
           method = 'L-BFGS-B')

summary(FitISCnChoice)
```

##bootstrap subjects to get errorbars on BICs

###function to create new BICs from random sample

```{r new ISCnChoice model BICs from samples}
ResampleBicsISCnChoice = function(){temp = xnew()
TestLlhISCnChoice = function(priorCopy, nChoices){
  tempData = temp %>%
    rowwise() %>%
    mutate(pred = ModelISC(Box, HandleSimilarity, RodSimilarity, nChoices, nChoices, priorCopy, Result))
  -sum(log(tempData$pred))
}
InitsTestISCnChoice = list(priorCopy = mean((temp %>% 
                                              select(Result)) == "Someone copied."),
                          nChoices = round(mean(c(temp$NumHandleChoices, temp$NumRodChoices))))
FitTestISCnChoice <- mle(TestLlhISCnChoice, start = InitsTestISCnChoice, lower = LwrsNChoice, upper = UprsNChoice, method = 'L-BFGS-B')
return(((-2*logLik(FitTestISCnChoice)[1])+(2*nrow(temp))))
}
```

###bootstrap BICs for ISCnChoice model

```{r bootstrap BICs for ISCnChoice model}
SamplesISCnChoice <- pbreplicate(10000,ResampleBicsISCnChoice())
mean(SamplesISCnChoice)
quantile(SamplesISCnChoice, c(0.025, 0.975))

ISCnChoiceDf <- data.frame(Model = 'ISCnChoice.Model',
                      BicMean = mean(SamplesISCnChoice),
                      BicUpper = mean(SamplesISCnChoice) + sd(SamplesISCnChoice),
                      BicLower = mean(SamplesISCnChoice) - sd(SamplesISCnChoice))
```

#Summarize MLE derived best parameters:

```{r summary table of best parameters}
data.frame("Model" = c("Full", "ISC", "nChoice", "ISCnChoice"), "Best Prior" = c(round(coef(FitFull), 2), round(coef(FitISC), 2), round(coef(FitNChoice)[1], 2), round(coef(FitISCnChoice)[1], 2)), "Best nChoice" = c(NA,NA,round(coef(FitNChoice)[2], 2), round(coef(FitISCnChoice)[2], 2)))

dfs <- rbind(FullDf, ISCDf, nChoiceDf, ISCnChoiceDf) #combine summary of resampled data
```

#compare BICs from the different models

```{r model BIC comparisons}
#Find BICs:
(-2*logLik(FitFull)[1])+(1*nrow(DatCopy2)) #full model BIC
(-2*logLik(FitISC)[1])+(1*nrow(DatCopy2)) #ISC model BIC
(-2*logLik(FitNChoice)[1])+(2*nrow(DatCopy2)) #nChoice model BIC
(-2*logLik(FitISCnChoice)[1])+(2*nrow(DatCopy2)) #ISC and nChoice model BIC

#Graph BICs:
data.frame("Full Model" = (-2*logLik(FitFull)[1])+(1*nrow(DatCopy2)), "ISC Model" = (-2*logLik(FitISC)[1])+(1*nrow(DatCopy2)), "nChoice Model" = (-2*logLik(FitNChoice)[1])+(2*nrow(DatCopy2)), "ISCnChoice Model" = (-2*logLik(FitISCnChoice)[1])+(2*nrow(DatCopy2))) %>%
  gather(Model, BIC) %>%
  ggplot(aes(x = Model, y = BIC, fill = Model)) +
  geom_bar(stat = "identity") +
  geom_errorbar(data = dfs, aes(x=Model, y = BicMean, ymin = BicLower, ymax = BicUpper), width = .33)+
  scale_x_discrete(limits=c("Full.Model","ISC.Model","nChoice.Model", "ISCnChoice.Model")) +
  theme_apa() + 
  guides(fill=FALSE) +
  xlab("Model") +
  ylab("BIC")+
  theme(axis.text.x = element_text(angle = 45, hjust=1))

```


